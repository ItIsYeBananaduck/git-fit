openapi: 3.0.3
info:
  title: Voice Synthesis API
  description: API for AI voice synthesis, caching, and user voice preferences
  version: 1.0.0
  contact:
    name: Git-Fit AI Team
    email: ai@git-fit.app

servers:
  - url: https://api.git-fit.app/v1
    description: Production server
  - url: https://staging-api.git-fit.app/v1
    description: Staging server

paths:
  /voice/preferences:
    get:
      tags:
        - Voice Preferences
      summary: Get user voice preferences
      description: Retrieve voice synthesis preferences for the authenticated user
      operationId: getVoicePreferences
      responses:
        '200':
          description: User voice preferences
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoicePreferences'
        '404':
          description: Voice preferences not configured
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Voice Preferences
      summary: Update voice preferences
      description: Update voice synthesis preferences for the authenticated user
      operationId: updateVoicePreferences
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VoicePreferencesUpdate'
      responses:
        '200':
          description: Voice preferences updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoicePreferences'
        '400':
          description: Invalid preferences data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Premium subscription required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /voice/clone:
    post:
      tags:
        - Voice Clone
      summary: Initiate voice cloning
      description: Start the voice cloning process for personalized synthesis
      operationId: initiateVoiceClone
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/VoiceCloneRequest'
      responses:
        '202':
          description: Voice cloning initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoiceCloneResponse'
        '400':
          description: Invalid audio samples
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Premium subscription required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Voice cloning rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /voice/clone/status:
    get:
      tags:
        - Voice Clone
      summary: Get voice cloning status
      description: Check the status of voice cloning process
      operationId: getVoiceCloneStatus
      responses:
        '200':
          description: Voice cloning status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoiceCloneStatus'
        '404':
          description: No voice cloning in progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /voice/synthesize:
    post:
      tags:
        - Voice Synthesis
      summary: Synthesize voice audio
      description: Generate voice audio for given text with specified tone
      operationId: synthesizeVoice
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VoiceSynthesisRequest'
      responses:
        '200':
          description: Voice audio generated successfully
          content:
            audio/mpeg:
              schema:
                type: string
                format: binary
            application/json:
              schema:
                $ref: '#/components/schemas/VoiceSynthesisResponse'
        '400':
          description: Invalid synthesis request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Premium subscription required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Voice synthesis rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /voice/cache:
    get:
      tags:
        - Voice Cache
      summary: Get cached voice clips
      description: Retrieve user's cached voice clips metadata
      operationId: getCachedVoiceClips
      parameters:
        - name: context
          in: query
          schema:
            type: string
          description: Filter by workout context
        - name: tone
          in: query
          schema:
            type: string
            enum: [whisper, neutral, hype]
          description: Filter by voice tone
      responses:
        '200':
          description: List of cached voice clips
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoiceCacheList'

    delete:
      tags:
        - Voice Cache
      summary: Clear voice cache
      description: Clear user's voice cache (all clips or specific ones)
      operationId: clearVoiceCache
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VoiceCacheClearRequest'
      responses:
        '200':
          description: Voice cache cleared successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoiceCacheClearResponse'

  /voice/cache/{cacheId}:
    get:
      tags:
        - Voice Cache
      summary: Get cached voice clip
      description: Retrieve a specific cached voice clip audio
      operationId: getCachedVoiceClip
      parameters:
        - name: cacheId
          in: path
          required: true
          schema:
            type: string
          description: Voice cache entry identifier
      responses:
        '200':
          description: Cached voice clip audio
          content:
            audio/mpeg:
              schema:
                type: string
                format: binary
        '404':
          description: Voice clip not found in cache
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Voice Cache
      summary: Delete cached voice clip
      description: Remove a specific voice clip from cache
      operationId: deleteCachedVoiceClip
      parameters:
        - name: cacheId
          in: path
          required: true
          schema:
            type: string
          description: Voice cache entry identifier
      responses:
        '204':
          description: Voice clip deleted successfully
        '404':
          description: Voice clip not found in cache
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /voice/interactions:
    post:
      tags:
        - Voice Interactions
      summary: Record voice interaction
      description: Record a voice interaction during workout
      operationId: recordVoiceInteraction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VoiceInteractionRequest'
      responses:
        '201':
          description: Voice interaction recorded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoiceInteraction'
        '400':
          description: Invalid interaction data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /voice/interactions/workout/{workoutId}:
    get:
      tags:
        - Voice Interactions
      summary: Get workout voice interactions
      description: Retrieve voice interactions for a specific workout
      operationId: getWorkoutVoiceInteractions
      parameters:
        - name: workoutId
          in: path
          required: true
          schema:
            type: string
          description: Workout entry identifier
      responses:
        '200':
          description: Voice interactions for workout
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoiceInteractionsList'

components:
  schemas:
    VoicePreferences:
      type: object
      properties:
        id:
          type: string
          description: Voice preferences identifier
        userId:
          type: string
          description: User identifier
        personality:
          type: string
          enum: [Alice, Aiden]
          description: AI personality for voice
        voiceEnabled:
          type: boolean
          description: Global voice on/off toggle
        toneAdaptation:
          type: boolean
          description: Enable context-aware tone changes
        accessibilityMode:
          type: boolean
          description: Enhanced visual/haptic feedback
        elevenLabsVoiceId:
          type: string
          nullable: true
          description: ElevenLabs voice clone ID
        voiceCloneStatus:
          type: string
          enum: [not_configured, cloning, ready, active, needs_update]
          description: Voice clone setup status
        lastVoiceSetup:
          type: string
          format: date-time
          nullable: true
          description: Last voice configuration update

    VoicePreferencesUpdate:
      type: object
      properties:
        personality:
          type: string
          enum: [Alice, Aiden]
          description: AI personality for voice
        voiceEnabled:
          type: boolean
          description: Global voice on/off toggle
        toneAdaptation:
          type: boolean
          description: Enable context-aware tone changes
        accessibilityMode:
          type: boolean
          description: Enhanced visual/haptic feedback

    VoiceCloneRequest:
      type: object
      required:
        - audioSamples
        - voiceName
      properties:
        audioSamples:
          type: array
          items:
            type: string
            format: binary
          minItems: 3
          maxItems: 10
          description: Audio samples for voice cloning (3-10 samples)
        voiceName:
          type: string
          maxLength: 50
          description: Name for the cloned voice
        personality:
          type: string
          enum: [Alice, Aiden]
          description: Target AI personality

    VoiceCloneResponse:
      type: object
      properties:
        cloneId:
          type: string
          description: Voice cloning job identifier
        status:
          type: string
          enum: [processing, completed, failed]
          description: Cloning status
        estimatedCompletionTime:
          type: string
          format: date-time
          description: Estimated completion time
        elevenLabsJobId:
          type: string
          description: ElevenLabs job identifier

    VoiceCloneStatus:
      type: object
      properties:
        cloneId:
          type: string
          description: Voice cloning job identifier
        status:
          type: string
          enum: [processing, completed, failed]
          description: Current cloning status
        progress:
          type: integer
          minimum: 0
          maximum: 100
          description: Completion percentage
        elevenLabsVoiceId:
          type: string
          nullable: true
          description: Generated ElevenLabs voice ID
        errorMessage:
          type: string
          nullable: true
          description: Error message if cloning failed
        completedAt:
          type: string
          format: date-time
          nullable: true
          description: Completion timestamp

    VoiceSynthesisRequest:
      type: object
      required:
        - text
        - tone
        - context
      properties:
        text:
          type: string
          maxLength: 280
          description: Text to synthesize
          example: "Great job! You're crushing this workout!"
        tone:
          type: string
          enum: [whisper, neutral, hype]
          description: Voice tone for synthesis
        context:
          type: string
          description: Workout context
          example: "high_strain_set"
        enableCaching:
          type: boolean
          default: true
          description: Whether to cache the generated audio
        personality:
          type: string
          enum: [Alice, Aiden]
          nullable: true
          description: Override personality if needed

    VoiceSynthesisResponse:
      type: object
      properties:
        audioUrl:
          type: string
          format: uri
          description: URL to synthesized audio
        duration:
          type: number
          description: Audio duration in seconds
        cached:
          type: boolean
          description: Whether audio was served from cache
        cacheId:
          type: string
          nullable: true
          description: Cache entry ID if cached
        generationLatency:
          type: number
          description: Time to generate audio in milliseconds

    VoiceCache:
      type: object
      properties:
        id:
          type: string
          description: Cache entry identifier
        textHash:
          type: string
          description: Hash of original text
        tone:
          type: string
          enum: [whisper, neutral, hype]
          description: Voice tone used
        context:
          type: string
          description: Workout context
        generatedAt:
          type: string
          format: date-time
          description: Generation timestamp
        lastUsedAt:
          type: string
          format: date-time
          description: Last usage timestamp
        usageCount:
          type: integer
          description: Number of times played
        duration:
          type: number
          description: Audio duration in seconds
        expiresAt:
          type: string
          format: date-time
          nullable: true
          description: Expiration timestamp

    VoiceCacheList:
      type: object
      properties:
        cacheEntries:
          type: array
          items:
            $ref: '#/components/schemas/VoiceCache'
        totalEntries:
          type: integer
          description: Total number of cached entries
        totalSize:
          type: number
          description: Total cache size in MB
        maxEntries:
          type: integer
          description: Maximum allowed cache entries

    VoiceCacheClearRequest:
      type: object
      properties:
        clearAll:
          type: boolean
          default: false
          description: Clear entire cache
        cacheIds:
          type: array
          items:
            type: string
          description: Specific cache entries to clear
        context:
          type: string
          nullable: true
          description: Clear entries for specific context
        olderThan:
          type: string
          format: date-time
          nullable: true
          description: Clear entries older than timestamp

    VoiceCacheClearResponse:
      type: object
      properties:
        clearedEntries:
          type: integer
          description: Number of entries cleared
        remainingEntries:
          type: integer
          description: Number of entries remaining
        freedSpace:
          type: number
          description: Space freed in MB

    VoiceInteractionRequest:
      type: object
      required:
        - workoutEntryId
        - aiResponseText
        - voiceTone
        - wasVoicePlayed
      properties:
        workoutEntryId:
          type: string
          description: Associated workout entry ID
        aiResponseText:
          type: string
          maxLength: 280
          description: Text of AI response
        voiceTone:
          type: string
          enum: [whisper, neutral, hype]
          description: Tone used for synthesis
        wasVoicePlayed:
          type: boolean
          description: Whether audio was actually played
        wasCached:
          type: boolean
          default: false
          description: Whether audio was served from cache
        generationLatency:
          type: number
          nullable: true
          description: Time to generate audio (ms)
        playbackLatency:
          type: number
          nullable: true
          description: Time to start playback (ms)

    VoiceInteraction:
      type: object
      properties:
        id:
          type: string
          description: Interaction identifier
        workoutEntryId:
          type: string
          description: Associated workout entry ID
        aiResponseText:
          type: string
          description: Text of AI response
        voiceTone:
          type: string
          enum: [whisper, neutral, hype]
          description: Tone used for synthesis
        wasVoicePlayed:
          type: boolean
          description: Whether audio was actually played
        wasCached:
          type: boolean
          description: Whether audio was served from cache
        generationLatency:
          type: number
          nullable: true
          description: Time to generate audio (ms)
        playbackLatency:
          type: number
          nullable: true
          description: Time to start playback (ms)
        timestamp:
          type: string
          format: date-time
          description: Interaction timestamp

    VoiceInteractionsList:
      type: object
      properties:
        interactions:
          type: array
          items:
            $ref: '#/components/schemas/VoiceInteraction'
        totalInteractions:
          type: integer
          description: Total number of interactions
        averageGenerationLatency:
          type: number
          nullable: true
          description: Average generation latency in ms
        averagePlaybackLatency:
          type: number
          nullable: true
          description: Average playback latency in ms
        cacheHitRate:
          type: number
          nullable: true
          description: Cache hit rate percentage

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error code
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          nullable: true
          description: Additional error details
        timestamp:
          type: string
          format: date-time
          description: Error timestamp

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

security:
  - BearerAuth: []
  - ApiKeyAuth: []

tags:
  - name: Voice Preferences
    description: Operations for managing user voice preferences
  - name: Voice Clone
    description: Operations for voice cloning and personalization
  - name: Voice Synthesis
    description: Operations for generating voice audio
  - name: Voice Cache
    description: Operations for managing voice audio cache
  - name: Voice Interactions
    description: Operations for tracking voice interactions during workouts